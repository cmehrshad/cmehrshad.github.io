{{/* Hugo Blox: Custom Tailwind Portfolio Block (left-aligned, simplified) */}}

{{ $page := .wcPage }}
{{ $block := .wcBlock }}

{{ $columns := $block.design.columns | default "1" }}
{{ $view := $block.design.view | default "masonry" }}

<div class="container {{ if eq $columns "2" }}lg:w-2/3{{ end }} mx-auto" data-portfolio-root>
  {{ with $block.content.title }}
    <h1 class="text-3xl font-semibold mb-1 text-center">{{ . }}</h1>
  {{ end }}
  {{ with $block.content.subtitle }}
    <p class="text-gray-600 mb-6 text-center"">{{ . }}</p>
  {{ end }}
  
  {{ with $block.content.text }}
    <div class="mb-4 prose max-w-none">
      {{ . | $page.RenderString | emojify }}
    </div>
  {{ end }}

  {{ if $block.content.buttons }}
    {{ $filter_default := default (int $block.content.default_button_index) 0 }}

    <div class="flex flex-wrap justify-center gap-2 mb-8" data-portfolio-buttons>
      {{ range $idx, $btn := $block.content.buttons }}
        <button
          type="button"
          class="px-3 py-1 text-sm rounded-full border transition
                 {{ if eq $idx $filter_default }}
                   bg-gray-900 text-white border-gray-900
                 {{ else }}
                   bg-white text-gray-700 border-gray-300 hover:bg-gray-100
                 {{ end }}"
          data-filter-tag="{{ $btn.tag | default "*" }}">
          {{ $btn.name }}
        </button>
      {{ end }}
    </div>
  {{ end }}

  {{/* SIMPLE QUERY:
        - default folder: projects
        - show all regular pages in those sections
        - JS does tag filtering client-side */}}

  {{ $folders := $block.content.filters.folders | default (slice "projects") }}
  {{ $query := where site.RegularPages "Section" "in" $folders }}

  {{ $sort_by := $block.content.sort_by | default "Date" }}
  {{ $sort_ascending := $block.content.sort_ascending | default false }}
  {{ $sort_order := cond $sort_ascending "asc" "desc" }}
  {{ $query = sort $query $sort_by $sort_order }}

  <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"
       data-portfolio-grid>
    {{ range $index, $item := $query }}
      {{ $tags := $item.Params.tags }}
      {{ $tags_str := "" }}
      {{ if $tags }}
        {{ $tags_str = delimit $tags "," }}
      {{ end }}

      <article
        class="portfolio-item transition"
        data-tags="{{ $tags_str }}">
        {{ partial "functions/render_view" (dict "page" $block "item" . "view" $view "index" $index) }}
      </article>
    {{ end }}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('[data-portfolio-root]').forEach(function(root) {
        const buttons = root.querySelectorAll('[data-filter-tag]');
        const grid = root.querySelector('[data-portfolio-grid]');
        if (!grid) return;
        const items = grid.querySelectorAll('[data-tags]');

        function applyFilter(tag) {
          items.forEach(function(item) {
            const tags = (item.getAttribute('data-tags') || '').split(',').map(function(t) { return t.trim(); });
            const show = (tag === '*') || tags.includes(tag);
            item.style.display = show ? '' : 'none';
          });
        }

        buttons.forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            e.preventDefault();

            const tag = btn.getAttribute('data-filter-tag') || '*';

            buttons.forEach(function(b) {
              b.classList.remove('bg-gray-900','text-white','border-gray-900');
              b.classList.add('bg-white','text-gray-700','border-gray-300');
            });

            btn.classList.remove('bg-white','text-gray-700','border-gray-300');
            btn.classList.add('bg-gray-900','text-white','border-gray-900');

            applyFilter(tag);
          });
        });

        const first = root.querySelector('[data-filter-tag]');
        if (first) {
          const defaultTag = first.getAttribute('data-filter-tag') || '*';
          applyFilter(defaultTag);
        }
      });
    });
  </script>
</div>
