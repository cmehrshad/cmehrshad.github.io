{{/* Hugo Blox: Custom Tailwind Portfolio Block â€” collection-style, dynamic columns */}}

{{ $page := .wcPage }}
{{ $block := .wcBlock }}
{{ $columns := $block.design.columns | default "1" }}
{{ $view := $block.design.view | default "masonry" }}

<section id="{{ $block.id | default "projects" }}" class="relative hbb-section blox-collection">
  <div class="home-section-bg"></div>

  <!-- ===== Title & Subtitle ===== -->
  <div class="flex flex-col items-center max-w-prose mx-auto gap-3 justify-center px-6 md:px-0">
    {{ with $block.content.title }}
      <div class="mb-2 text-3xl font-bold text-gray-900 dark:text-white text-center">{{ . }}</div>
    {{ end }}
    {{ with $block.content.subtitle }}
      <p class="text-gray-600 dark:text-gray-400 text-center mb-6">{{ . }}</p>
    {{ end }}
  </div>

  <!-- ===== Content Container ===== -->
  <div class="flex flex-col items-center px-6">
    <div class="container px-8 mx-auto xl:px-5 py-5 lg:py-8 max-w-screen-lg" data-portfolio-root>

      {{ with $block.content.text }}
        <div class="mb-4 prose max-w-none">
          {{ . | $page.RenderString | emojify }}
        </div>
      {{ end }}

      <!-- ===== Filter Buttons ===== -->
      {{ if $block.content.buttons }}
        {{ $filter_default := default (int $block.content.default_button_index) 0 }}
        <div class="flex flex-wrap justify-center gap-2 mb-8" data-portfolio-buttons>
          {{ range $idx, $btn := $block.content.buttons }}
            <button
              type="button"
              class="px-3 py-1 text-sm rounded-full border transition
                     {{ if eq $idx $filter_default }}
                       bg-gray-900 text-white border-gray-900
                     {{ else }}
                       bg-white text-gray-700 border-gray-300 hover:bg-gray-100
                     {{ end }}"
              data-filter-tag="{{ $btn.tag | default "*" }}">
              {{ $btn.name }}
            </button>
          {{ end }}
        </div>
      {{ end }}

      <!-- ===== Projects Grid ===== -->
      {{/* Determine grid columns dynamically */}}
      {{ $gridCols := cond (eq $columns "1") "md:grid-cols-1" (cond (eq $columns "2") "md:grid-cols-2" "md:grid-cols-3") }}

      {{ $folders := $block.content.filters.folders | default (slice "projects") }}
      {{ $query := where site.RegularPages "Section" "in" $folders }}
      {{ $sort_by := $block.content.sort_by | default "Date" }}
      {{ $sort_ascending := $block.content.sort_ascending | default false }}
      {{ $sort_order := cond $sort_ascending "asc" "desc" }}
      {{ $query = sort $query $sort_by $sort_order }}

      <div class="grid gap-10 {{ $gridCols }} lg:gap-10" data-portfolio-grid>
        {{ range $index, $item := $query }}
          {{ $tags := $item.Params.tags }}
          {{ $tags_str := "" }}
          {{ if $tags }}{{ $tags_str = delimit $tags "," }}{{ end }}
          <article class="portfolio-item transition" data-tags="{{ $tags_str }}">
            {{ partial "functions/render_view" (dict "page" $block "item" . "view" $view "index" $index) }}
          </article>
        {{ end }}
      </div>
    </div>
  </div>

  <!-- ===== JS: Tag Filtering ===== -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('[data-portfolio-root]').forEach(function(root) {
        const buttons = root.querySelectorAll('[data-filter-tag]');
        const grid = root.querySelector('[data-portfolio-grid]');
        if (!grid) return;
        const items = grid.querySelectorAll('[data-tags]');

        function applyFilter(tag) {
          items.forEach(function(item) {
            const tags = (item.getAttribute('data-tags') || '').split(',').map(t => t.trim());
            const show = (tag === '*') || tags.includes(tag);
            item.style.display = show ? '' : 'none';
          });
        }

        buttons.forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            const tag = btn.getAttribute('data-filter-tag') || '*';
            buttons.forEach(function(b) {
              b.classList.remove('bg-gray-900','text-white','border-gray-900');
              b.classList.add('bg-white','text-gray-700','border-gray-300');
            });
            btn.classList.remove('bg-white','text-gray-700','border-gray-300');
            btn.classList.add('bg-gray-900','text-white','border-gray-900');
            applyFilter(tag);
          });
        });

        const first = root.querySelector('[data-filter-tag]');
        if (first) applyFilter(first.getAttribute('data-filter-tag') || '*');
      });
    });
  </script>
</section>
